{% if not is_partial %}
  {% set title = (page_title|default('Manage Curiosity')) ~ ' | ' ~ app_name %}
  {% extends 'layouts/admin.twig' %}
{% endif %}

{% block sidebar_menu2 %}
    <ul>
        <li><a href="dashboard">Dashboard</a></li>
        <li><a href="bo/manage" class="active">Manage</a></li>
    </ul>

    <h3>Modules</h3>
    <ul>
        {% for key, module in modules %}
            <li>
                <a href="{{ module.route }}">
                    {{ module.icon }} {{ module.name }}
                </a>
            </li>
        {% endfor %}
    </ul>
{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% include "partials/admin/breadcrumb.twig" %}

<style>
.container {
    max-width: 1200px;
    padding:20px;
}

#levels-list {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
}

#levels-list .list-group-item {
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    list-style:none;
}

#levels-list .list-group-item:hover {
    background: #f8f9fa;
}

#levels-list .list-group-item.active {
    background: #0d6efd;
    color: #fff;
    font-weight: bold;
}

/* Curiosity Table */
#curiosities-table th,
#curiosities-table td {
    vertical-align: middle;
    text-align: center;
}

#curiosities-table tbody tr:hover {
    background: #f9f9f9;
}

/* Buttons */
#add-curiosity,
#add-level {
    width: 100%;
    font-weight: 500;
}

.edit-btn {
    background-color: #ffc107;
    border: none;
    color: #212529;
}

.delete-btn {
    background-color: #dc3545;
    border: none;
}

/* Modal */
.modal-content {
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.modal-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    font-weight: 600;
}

.modal-footer .btn {
    min-width: 100px;
}

</style>
<div class="container mt-4">
    <h2>Manage Curiosities</h2>
    <div class="row">
        <!-- Levels Sidebar -->
        <div class="col-md-3">
            <h5>Levels</h5>
            <ul id="levels-list" class="list-group">
                <!-- Loaded by AJAX -->
            </ul>
            <button class="btn btn-sm btn-primary mt-2" id="add-level">+ Add Level</button>
        </div>

        <!-- Curiosities Table -->
        <div class="col-md-9">
            <h5>Curiosities</h5>
            <table class="table table-bordered" id="curiosities-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Order</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filled by AJAX -->
                </tbody>
            </table>
            <button class="btn btn-sm btn-success" id="add-curiosity">+ Add Curiosity</button>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="curiosityModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="curiosity-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Curiosity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" name="id" id="curiosity-id">

            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" class="form-control" name="title" id="curiosity-title" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Type</label>
                <select class="form-select" name="type" id="curiosity-type">
                    <option value="type_multicheck">MultiCheck</option>
                    <option value="type_toggle">Toggle</option>
                    <option value="type_tags">Tags</option>
                    <option value="type_map">Map</option>
                    <option value="type_emoji">Emoji</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Order</label>
                <input type="number" class="form-control" name="ord" id="curiosity-ord" value="1">
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(function(){
    let currentLevel = null;

    function loadLevels(){
        $.getJSON('api/v1/levels', function(data){
            $('#levels-list').empty();
            data.forEach(level => {
                $('#levels-list').append(`
                    <li class="list-group-item level-item" data-id="${level.id}">
                        ${level.name}
                    </li>
                `);
            });
        });
    }

    function loadCuriosities(levelId){
        currentLevel = levelId;
        $.getJSON('api/v1/curiosities?level=' + levelId, function(data){
            let tbody = $('#curiosities-table tbody').empty();
            
            data.forEach(c => {
                tbody.append(`
                    <tr>
                        <td>${c.curiosity_id}</td>
                        <td>${c.condition_key}</td>
                        <td>${c.input_type}</td>
                        <td>${c.ord}</td>
                        <td>
                            <button class="btn btn-sm btn-warning edit-btn" data-id="${c.curiosity_id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${c.curiosity_id}">Delete</button>
                        </td>
                    </tr>
                `);
            });
        });
    }

    // Load levels on page load
    loadLevels();

    // Click level
    $(document).on('click', '.level-item', function(){
        $('#curiosities-table tbody').empty();
        let id = $(this).data('id');
        loadCuriosities(id);
        $('.level-item').removeClass('active');
        $(this).addClass('active');
    });

    // Add curiosity
    $('#add-curiosity').click(function(){
        if(!currentLevel) return alert('Select a level first');
        $('#curiosity-form')[0].reset();
        $('#curiosity-id').val('');
        $('#curiosityModal').modal('show');
    });

    // Edit curiosity
    $(document).on('click', '.edit-btn', function(){
        let id = $(this).data('id');
        $.getJSON('api/v1/curiosity/' + id, function(c){
            $('#curiosity-id').val(c.curiosity_id);
            $('#curiosity-title').val(c.elem_key);
            $('#curiosity-type').val(c.input_type);
            $('#curiosity-ord').val(c.ord);
            $('#curiosityModal').modal('show');
        });
    });

    // Save curiosity
    $('#curiosity-form').submit(function(e){
        e.preventDefault();
        let data = $(this).serialize() + '&level=' + currentLevel;
        $.post('api/v1/curiosity/save', data, function(){
            $('#curiosityModal').modal('hide');
            loadCuriosities(currentLevel);
        });
    });

    // Delete curiosity
    $(document).on('click', '.delete-btn', function(){
        if(!confirm('Delete this curiosity?')) return;
        let id = $(this).data('id');
        $.post('api/v1/curiosity/delete', {id}, function(){
            loadCuriosities(currentLevel);
        });
    });
});
</script>
{% endblock %}
